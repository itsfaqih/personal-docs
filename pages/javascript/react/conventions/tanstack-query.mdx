# Tanstack Query

I use Tanstack Query for server state management.

## Installation

```bash copy
npm install @tanstack/react-query
```

## Usage

```tsx filename="<name>.query.ts" copy
import { QueryClient, QueryFunction, useQuery } from "@tanstack/react-query";
import { NamesFilters } from "@/schemas/name.schema";
import { EndUserError } from "@/utils/error.utils";

export function namesQuery(filters: NamesFilters = {}) {
  return {
    queryKey: ["names", filters],
    async queryFn({ signal }: Parameters<QueryFunction>[0]) {
      // Fetch data
    },
  };
}

type UseNamesQueryOptions = {
  filters?: NamesFilters;
};

export function useNamesQuery(options?: UseNamesQueryOptions) {
  return useQuery(namesQuery(options?.filters));
}

type FetchNamesQueryParams = {
  queryClient: QueryClient;
  filters?: NamesFilters;
};

export async function fetchNamesQuery({
  queryClient,
  filters = {},
}: FetchNamesQueryParams) {
  const namesQueryOpt = namesQuery(filters);

  queryClient.getQueryData(namesQueryOpt.queryKey) ??
    (await queryClient.fetchQuery(namesQueryOpt).catch((error) => {
      if (error instanceof EndUserError) {
        throw error;
      }
    }));
}

export function nameQuery(id?: string) {
  return {
    queryKey: ["name", id],
    async queryFn({ signal }: Parameters<QueryFunction>[0]) {
      // Fetch data
    },
    enabled: id !== undefined,
  };
}

type UseNameQueryOptions = {
  id?: string;
};

export function useNameQuery(options: UseNameQueryOptions) {
  return useQuery(nameQuery(options.id));
}

type FetchNameQueryParams = {
  queryClient: QueryClient;
  id: string;
};

export async function fetchNameQuery({
  queryClient,
  id,
}: FetchNameQueryParams) {
  const nameQueryOpt = nameQuery(id);

  queryClient.getQueryData(nameQueryOpt.queryKey) ??
    (await queryClient.fetchQuery(nameQueryOpt).catch((error) => {
      if (error instanceof EndUserError) {
        throw error;
      }
    }));
}
```
